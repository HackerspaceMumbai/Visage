@page "/"
@* T020: Updated Home.razor with InteractiveAuto render mode and event sections *@
@* Inherit default InteractiveServer from App.razor *@
@using Visage.FrontEnd.Shared.Services
@using Microsoft.AspNetCore.Components.Routing
@using Visage.FrontEnd.Shared.Models
@using Visage.FrontEnd.Shared.Components
@using Visage.FrontEnd.Shared.Components.Events
@using Visage.Shared.Models
@using Microsoft.JSInterop
@inject NavigationManager NavigationManager
@inject IFormFactor FormFactor
@inject IEventService EventService
@inject IImageUrlTransformer ImageUrlTransformer
@inject ILogger<Home> Logger
@inject IProfileService ProfileService
@inject IJSRuntime JSRuntime

<PageTitle>Visage - Hackerspace Mumbai Events</PageTitle>

<!-- T024: AIDE Completion Banner (show if mandatory complete but AIDE incomplete) -->
@if (profileCompletionStatus != null)
{
    <AideCompletionBanner 
        IsProfileComplete="@profileCompletionStatus.IsProfileComplete" 
        IsAideProfileComplete="@profileCompletionStatus.IsAideProfileComplete" />
}

<!-- T020-T025: Upcoming Events Section -->
<section class="p-4 md:p-6 lg:p-8">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-base-content">Upcoming Events</h2>
        
        <NavLink class="btn btn-primary btn-sm" href="/schedule-event"> 
            <span>‚ûï</span> Schedule Event
        </NavLink>
    </div>

    @* RSVP feedback *@
    @if (!string.IsNullOrEmpty(rsvpMessage))
    {
        <div class="alert alert-success mb-4">
            <span>@rsvpMessage</span>
        </div>
    }

    @if (rsvpInProgress)
    {
        <div class="mb-4"><span class="loading loading-spinner loading-sm"></span> Registering...</div>
    }
    
    <!-- T021: Load upcoming events with error handling -->
    @if (errorMessage != null)
    {
        <div class="alert alert-error mb-4">
            <span>‚ö†Ô∏è @errorMessage</span>
            <button class="btn btn-sm" @onclick="RetryLoadEvents">Retry</button>
        </div>
    }
    else if (upcomingEventViewModels == null)
    {
        <!-- T022: Loading skeleton -->
        <EventList Events="null" SkeletonCount="6" />
    }
    else if (!upcomingEventViewModels.Any())
    {
        <!-- T022: Empty state -->
        <EmptyState 
            Icon="üìÖ"
            Title="No Upcoming Events"
            Message="Check back soon for exciting new events from Hackerspace Mumbai!" />
    }
    else
    {
        <EventList 
            Events="@upcomingEventViewModels"
            OnRSVP="HandleEventRSVP"
            EmptyIcon="üìÖ"
            EmptyTitle="No Upcoming Events"
            EmptyMessage="Check back soon for exciting new events from Hackerspace Mumbai!" />
    }
</section>

<!-- Past Events Section (to be enhanced in Phase 4) -->
<section class="p-4 md:p-6 lg:p-8 mt-8">
    <h2 class="text-3xl font-bold text-base-content mb-6">Past Events</h2>
    
    @if (pastEventViewModels == null)
    {
        <EventList Events="null" SkeletonCount="4" />
    }
    else if (!pastEventViewModels.Any())
    {
        <EmptyState 
            Icon="üìö"
            Title="No Past Events"
            Message="Our event history will appear here." />
    }
    else
    {
        <EventList 
            Events="@pastEventViewModels"
            EmptyIcon="üìö"
            EmptyTitle="No Past Events"
            EmptyMessage="Our event history will appear here." />
    }
</section>



@code {
    [CascadingParameter]
    private Task<AuthenticationState>? authenticationState { get; set; }

    private List<EventViewModel>? upcomingEventViewModels;
    private List<EventViewModel>? pastEventViewModels;
    private string? errorMessage;
    private string? Username;
    private ProfileCompletionStatusDto? profileCompletionStatus;
    private bool hasCheckedProfileCompletion;
    private bool shouldRedirectToMandatoryRegistration;

    // RSVP UI state
    private string? rsvpMessage;
    private bool rsvpInProgress;

    // T021: Inject EventService and load upcoming events
    // T036: Check profile completion DURING PRERENDER when HttpContext is available
    protected override async Task OnInitializedAsync()
    {
        // Check profile completion first (during prerender when HttpContext is available)
        if (authenticationState != null)
        {
            try
            {
                var authState = await authenticationState;
                var user = authState?.User;

                if (user?.Identity is not null && user.Identity.IsAuthenticated)
                {
                    Username = user.Identity.Name ?? string.Empty;
                    Logger.LogInformation("Home: Authenticated user {Username}, checking profile completion during prerender", Username);

                    // Call ProfileService during prerender when HttpContext is available
                    profileCompletionStatus = await ProfileService.GetCompletionStatusAsync();

                    if (profileCompletionStatus == null)
                    {
                        Logger.LogWarning("Home: ProfileService returned null during prerender");
                    }
                    else if (!profileCompletionStatus.IsProfileComplete)
                    {
                        Logger.LogInformation("Home: User {Username} has incomplete profile, scheduling redirect", Username);
                        shouldRedirectToMandatoryRegistration = true;
                        hasCheckedProfileCompletion = true;
                        return;
                    }
                    else
                    {
                        Logger.LogInformation("Home: User {Username} has complete profile", Username);
                    }

                    hasCheckedProfileCompletion = true;
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error checking profile completion during prerender");
            }
        }

        // Load events only if we didn't schedule a redirect
        if (!shouldRedirectToMandatoryRegistration)
        {
            await LoadEventsAsync();
        }
    }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return Task.CompletedTask;
        }

        if (shouldRedirectToMandatoryRegistration)
        {
            Logger.LogInformation("Home: Redirecting to mandatory registration");
            NavigationManager.NavigateTo("/registration/mandatory", forceLoad: true);
        }

        return Task.CompletedTask;
    }

    // Extract event-loading logic to avoid manually calling lifecycle methods
    private async Task LoadEventsAsync()
    {
        try
        {
            // Clear any previous error state
            errorMessage = null;

            // T021: Load events with error handling (T022)
            var upcomingEvents = await EventService.GetUpcomingEvents();
            var pastEvents = await EventService.GetPastEvents();

            // T025: Map Event to EventViewModel with computed properties
            upcomingEventViewModels = MapToViewModels(upcomingEvents);
            pastEventViewModels = MapToViewModels(pastEvents);

            Console.WriteLine("Home Component Initialized");
            Console.WriteLine("Home RenderInfo: " + RendererInfo.Name);
            Console.WriteLine("Is Home Component Interactive? " + RendererInfo.IsInteractive);
            Console.WriteLine("AssignedRenderMode: " + AssignedRenderMode);
        }
        catch (Exception ex)
        {
            // T022: Error handling with user-friendly message
            Logger.LogError(ex, "Error loading events in Home component");
            errorMessage = "Unable to load events. Please try again.";
        }
    }



    // T022: Retry button handler
    private async Task RetryLoadEvents()
    {
        upcomingEventViewModels = null;
        pastEventViewModels = null;
        await LoadEventsAsync();
    }

    // Handle RSVP from event cards
    private async Task HandleEventRSVP(EventViewModel evt)
    {
        // Reset any previous message
        rsvpMessage = null;

        try
        {
            rsvpInProgress = true;

            // Ensure user is authenticated
            if (authenticationState is null)
            {
                // If we don't have auth info, just send user to login
                var redirect = $"Account/Login?redirectUri={Uri.EscapeDataString(NavigationManager.Uri)}";
                NavigationManager.NavigateTo(redirect, forceLoad: true);
                return;
            }

            var authState = await authenticationState;
            var user = authState?.User;
            if (user?.Identity is null || !user.Identity.IsAuthenticated)
            {
                var redirect = $"Account/Login?redirectUri={Uri.EscapeDataString(NavigationManager.Uri)}";
                NavigationManager.NavigateTo(redirect, forceLoad: true);
                return;
            }

            // Check profile completion
            if (!hasCheckedProfileCompletion || profileCompletionStatus == null)
            {
                profileCompletionStatus = await ProfileService.GetCompletionStatusAsync();
                hasCheckedProfileCompletion = true;
            }

            if (profileCompletionStatus is null || !profileCompletionStatus.IsProfileComplete)
            {
                // Redirect user to mandatory registration
                NavigationManager.NavigateTo("/registration/mandatory", forceLoad: true);
                return;
            }

            // Call EventService to register
            var registration = await EventService.RegisterForEventAsync(evt.EventId);

            if (registration != null)
            {
                rsvpMessage = "You're registered ‚Äî check 'My Registrations' for details.";
            }
            else
            {
                rsvpMessage = "Registration failed. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during RSVP for event {EventId}", evt.EventId);
            rsvpMessage = "An error occurred while registering. Please try again.";
        }
        finally
        {
            rsvpInProgress = false;
            StateHasChanged();
        }
    }

    // T025: Helper method to map Event to EventViewModel with image URL transformation
    private List<EventViewModel> MapToViewModels(List<Visage.FrontEnd.Shared.Models.EventDto> events)
    {
        var viewModels = events.Select(evt => {
            Logger.LogInformation("Mapping event: {Title}, CoverPicture: {CoverPicture}", 
                evt.Title, evt.CoverPicture ?? "(null)");
            
            var eventDateTime = evt.StartDate.ToDateTime(evt.StartTime);
            
            // Apply CDN transformation to image URL using injected transformer
            var optimizedImageUrl = ImageUrlTransformer.Transform(evt.CoverPicture);
            
            return new EventViewModel
            {
                EventId = evt.Id,
                Id = evt.Id.Value.ToGuid(), // Convert StrictId's Ulid to Guid
                Name = evt.Title,
                Date = eventDateTime,
                Location = evt.Location ?? "TBA",
                CoverImageUrl = evt.CoverPicture,
                OptimizedImageUrl = optimizedImageUrl,
                Description = evt.Description ?? "",
                RsvpLink = null, // Not available in current Event model
                AttendeeCount = 0, // Not available in current Event model
                // Assuming eventDateTime is already in UTC, or convert as needed:
                Status = eventDateTime > DateTime.UtcNow 
                    ? EventStatus.Upcoming 
                    : EventStatus.Completed
            };
        }).ToList();
        
        Logger.LogInformation("Mapped {Count} events to view models", viewModels.Count);
        return viewModels;
    }
}
