@page "/"
@* T020: Updated Home.razor with InteractiveAuto render mode and event sections *@
@* Inherit default InteractiveServer from App.razor *@
@using Visage.FrontEnd.Shared.Services
@using Microsoft.AspNetCore.Components.Routing
@using Visage.FrontEnd.Shared.Models
@using Visage.FrontEnd.Shared.Components
@using Visage.FrontEnd.Shared.Components.Events
@inject NavigationManager NavigationManager
@inject IFormFactor FormFactor
@inject IEventService EventService
@inject IImageUrlTransformer ImageUrlTransformer
@inject ILogger<Home> Logger

<PageTitle>Visage - Hackerspace Mumbai Events</PageTitle>

<!-- T020-T025: Upcoming Events Section -->
<section class="p-4 md:p-6 lg:p-8">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-base-content">Upcoming Events</h2>
        
        <NavLink class="btn btn-primary btn-sm" href="/schedule-event"> 
            <span>‚ûï</span> Schedule Event
        </NavLink>
    </div>
    
    <!-- T021: Load upcoming events with error handling -->
    @if (errorMessage != null)
    {
        <div class="alert alert-error mb-4">
            <span>‚ö†Ô∏è @errorMessage</span>
            <button class="btn btn-sm" @onclick="RetryLoadEvents">Retry</button>
        </div>
    }
    else if (upcomingEventViewModels == null)
    {
        <!-- T022: Loading skeleton -->
        <EventList Events="null" SkeletonCount="6" />
    }
    else if (!upcomingEventViewModels.Any())
    {
        <!-- T022: Empty state -->
        <EmptyState 
            Icon="üìÖ"
            Title="No Upcoming Events"
            Message="Check back soon for exciting new events from Hackerspace Mumbai!" />
    }
    else
    {
        <EventList 
            Events="@upcomingEventViewModels"
            EmptyIcon="üìÖ"
            EmptyTitle="No Upcoming Events"
            EmptyMessage="Check back soon for exciting new events from Hackerspace Mumbai!" />
    }
</section>

<!-- Past Events Section (to be enhanced in Phase 4) -->
<section class="p-4 md:p-6 lg:p-8 mt-8">
    <h2 class="text-3xl font-bold text-base-content mb-6">Past Events</h2>
    
    @if (pastEventViewModels == null)
    {
        <EventList Events="null" SkeletonCount="4" />
    }
    else if (!pastEventViewModels.Any())
    {
        <EmptyState 
            Icon="üìö"
            Title="No Past Events"
            Message="Our event history will appear here." />
    }
    else
    {
        <EventList 
            Events="@pastEventViewModels"
            EmptyIcon="üìö"
            EmptyTitle="No Past Events"
            EmptyMessage="Our event history will appear here." />
    }
</section>



@code {
    [CascadingParameter]
    private Task<AuthenticationState>? authenticationState { get; set; }

    private List<EventViewModel>? upcomingEventViewModels;
    private List<EventViewModel>? pastEventViewModels;
    private string? errorMessage;
    private string? Username;
    private bool RequiresRegistrationRedirect = false;
    private bool IsNewUser;
    private bool HasCompletedRegistration;

    // T021: Inject EventService and load upcoming events
    protected override async Task OnInitializedAsync()
    {
        await LoadEventsAsync();
    }

    // Extract event-loading logic to avoid manually calling lifecycle methods
    private async Task LoadEventsAsync()
    {
        try
        {
            // Clear any previous error state
            errorMessage = null;
            
            // T021: Load events with error handling (T022)
            var upcomingEvents = await EventService.GetUpcomingEvents();
            var pastEvents = await EventService.GetPastEvents();
            
            // T025: Map Event to EventViewModel with computed properties
            upcomingEventViewModels = MapToViewModels(upcomingEvents);
            pastEventViewModels = MapToViewModels(pastEvents);

            Console.WriteLine("Home Component Initialized");
            Console.WriteLine("Home RenderInfo: " + RendererInfo.Name);
            Console.WriteLine("Is Home Component Interactive? " + RendererInfo.IsInteractive);
            Console.WriteLine("AssignedRenderMode: " + AssignedRenderMode);

            // Authentication logic (existing)
            if (authenticationState is not null)
            {
                var authState = await authenticationState;
                var user = authState?.User;

                if (user?.Identity is not null && user.Identity.IsAuthenticated)
                {
                    Username = user.Identity.Name ?? string.Empty;

                    if (!bool.TryParse(
                        user.Claims?.FirstOrDefault(c => c.Type == "is_new_user")?.Value ?? "false",
                        out IsNewUser))
                    {
                        IsNewUser = false;
                    }

                    if (!bool.TryParse(
                        user.Claims?.FirstOrDefault(c => c.Type == "registration_complete")?.Value ?? "false",
                        out HasCompletedRegistration))
                    {
                        HasCompletedRegistration = false;
                    }

                    Logger.LogInformation("Home RendererInfo IsInteractive?: {Interactive}", RendererInfo.IsInteractive);
                    Logger.LogInformation("Home RenderInfo.Name: {RenderName}", RendererInfo.Name);

                    if (IsNewUser || !HasCompletedRegistration)
                    {
                        Logger.LogInformation("Home New user detected: {Username}, needs registration", Username);
                        RequiresRegistrationRedirect = true;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            // T022: Error handling with user-friendly message
            Logger.LogError(ex, "Error loading events in Home component");
            errorMessage = "Unable to load events. Please try again.";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            if (RequiresRegistrationRedirect)
            {
                Logger.LogInformation("Redirecting new user to registration page");
                RequiresRegistrationRedirect = false;
                NavigationManager.NavigateTo("/user-registration", forceLoad: false);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in Home component OnAfterRenderAsync");
        }
    }

    // T022: Retry button handler
    private async Task RetryLoadEvents()
    {
        upcomingEventViewModels = null;
        pastEventViewModels = null;
        await LoadEventsAsync();
    }

    // T025: Helper method to map Event to EventViewModel with image URL transformation
    private List<EventViewModel> MapToViewModels(List<Event> events)
    {
        var viewModels = events.Select(evt => {
            Logger.LogInformation("Mapping event: {Title}, CoverPicture: {CoverPicture}", 
                evt.Title, evt.CoverPicture ?? "(null)");
            
            var eventDateTime = evt.StartDate.ToDateTime(evt.StartTime);
            
            // Apply CDN transformation to image URL using injected transformer
            var optimizedImageUrl = ImageUrlTransformer.Transform(evt.CoverPicture);
            
            return new EventViewModel
            {
                Id = evt.Id.Value.ToGuid(), // Convert StrictId's Ulid to Guid
                Name = evt.Title,
                Date = eventDateTime,
                Location = evt.Location ?? "TBA",
                CoverImageUrl = evt.CoverPicture,
                OptimizedImageUrl = optimizedImageUrl,
                Description = evt.Description ?? "",
                RsvpLink = null, // Not available in current Event model
                AttendeeCount = 0, // Not available in current Event model
                // Assuming eventDateTime is already in UTC, or convert as needed:
                Status = eventDateTime > DateTime.UtcNow 
                    ? EventStatus.Upcoming 
                    : EventStatus.Completed
            };
        }).ToList();
        
        Logger.LogInformation("Mapped {Count} events to view models", viewModels.Count);
        return viewModels;
    }
}
