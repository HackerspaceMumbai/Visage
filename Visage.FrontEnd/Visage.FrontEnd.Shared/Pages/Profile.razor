@page "/profile/{UserId}"
@attribute [Authorize]
@inject IProfileService ProfileService
@inject ILogger<Profile> Logger

@using Visage.FrontEnd.Shared.Services
@using Visage.Shared.Models

<PageTitle>Profile</PageTitle>

@if (IsLoading)
{
    <div class="flex justify-center items-center h-64">
        <span class="loading loading-spinner loading-lg"></span>
    </div>
}
else if (HasError)
{
    <div class="alert alert-error shadow-lg mt-4">
        <span>Error loading profile. Please try again later.</span>
    </div>
}
else if (UserProfile is not null)
{
    <div class="max-w-xl mx-auto mt-8 p-6 bg-base-200 rounded-lg shadow">
        <h2 class="text-2xl font-bold mb-4">Your Profile</h2>
        <form @onsubmit="HandleValidSubmit" @onsubmit:preventDefault="true">
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">First Name</span>
                </label>
                <input class="input input-bordered" @bind="UserProfile.FirstName" required />
            </div>
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Last Name</span>
                </label>
                <input class="input input-bordered" @bind="UserProfile.LastName" required />
            </div>
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Email</span>
                </label>
                <input class="input input-bordered" value="@UserProfile.Email" readonly />
            </div>
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">LinkedIn</span>
                </label>
                <input class="input input-bordered" @bind="UserProfile.LinkedInProfile" />
            </div>
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">GitHub</span>
                </label>
                <input class="input input-bordered" @bind="UserProfile.GitHubProfile" />
            </div>
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Profile Status</span>
                </label>
                <input class="input input-bordered" value="@(UserProfile.IsProfileComplete ? "Complete" : "Incomplete")" readonly />
            </div>
            <div class="flex gap-4 mt-6">
                <button class="btn btn-primary" type="submit" disabled="@IsSaving">
                    @if (IsSaving)
                    {
                        <span class="loading loading-spinner loading-sm"></span>
                    }
                    Save
                </button>
                <button class="btn btn-secondary" type="button" @onclick="ResetForm" disabled="@IsSaving">Cancel</button>
            </div>
            @if (SaveSuccess)
            {
                <div class="alert alert-success shadow-lg mt-4">
                    <span>Profile updated successfully!</span>
                </div>
            }
            @if (SaveError)
            {
                <div class="alert alert-error shadow-lg mt-4">
                    <span>Failed to update profile. Please try again.</span>
                </div>
            }
        </form>
    </div>
}

@code {
    private Visage.Shared.Models.User? UserProfile;
    private Visage.Shared.Models.User? OriginalProfile;
    private bool IsLoading = true;
    private bool HasError = false;
    private bool IsSaving = false;
    private bool SaveSuccess = false;
    private bool SaveError = false;

    [Parameter]
    public string UserId { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Logger.LogInformation("Profile: Loading profile");
            UserProfile = await ProfileService.GetProfileAsync();
            
            if (UserProfile != null)
            {
                // Create a copy for reset functionality
                OriginalProfile = new Visage.Shared.Models.User
                {
                    Id = UserProfile.Id,
                    FirstName = UserProfile.FirstName,
                    LastName = UserProfile.LastName,
                    Email = UserProfile.Email,
                    LinkedInProfile = UserProfile.LinkedInProfile,
                    GitHubProfile = UserProfile.GitHubProfile,
                    IsProfileComplete = UserProfile.IsProfileComplete
                };
            }
            HasError = false;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading profile");
            HasError = true;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task HandleValidSubmit()
    {
        IsSaving = true;
        SaveSuccess = false;
        SaveError = false;
        try
        {
            if (UserProfile is not null)
            {
                var success = await ProfileService.UpdateProfileAsync(UserProfile);
                if (success)
                {
                    SaveSuccess = true;
                    // Update original profile copy
                    OriginalProfile = new Visage.Shared.Models.User
                    {
                        Id = UserProfile.Id,
                        FirstName = UserProfile.FirstName,
                        LastName = UserProfile.LastName,
                        Email = UserProfile.Email,
                        LinkedInProfile = UserProfile.LinkedInProfile,
                        GitHubProfile = UserProfile.GitHubProfile,
                        IsProfileComplete = UserProfile.IsProfileComplete
                    };
                }
                else
                {
                    SaveError = true;
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving profile");
            SaveError = true;
        }
        finally
        {
            IsSaving = false;
        }
    }

    private void ResetForm()
    {
        if (OriginalProfile is not null && UserProfile is not null)
        {
            UserProfile.FirstName = OriginalProfile.FirstName;
            UserProfile.LastName = OriginalProfile.LastName;
            UserProfile.LinkedInProfile = OriginalProfile.LinkedInProfile;
            UserProfile.GitHubProfile = OriginalProfile.GitHubProfile;
        }
        SaveSuccess = false;
        SaveError = false;
    }
}

