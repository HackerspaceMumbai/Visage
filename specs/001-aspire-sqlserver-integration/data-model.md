# Data Model: SQL Server Aspire Integration

**Feature**: SQL Server Aspire Integration  
**Date**: 2025-10-17  
**Purpose**: Document data model changes and database configuration for Aspire-managed SQL Server

## Overview

This feature is an infrastructure migration that does **not introduce new entities**. The existing data models in Registration and Eventing services remain unchanged. This document focuses on the database configuration changes required to migrate from standalone SQL Server to Aspire-managed SQL Server.

## Database Architecture

### SQL Server Resource Structure

```
SQL Server Instance (Aspire-managed)
├── registrationdb (Database)
│   └── Tables managed by RegistrantDB DbContext
│       └── (Existing schema - no changes)
└── eventingdb (Database)
    └── Tables managed by EventDB DbContext
        └── (Existing schema - no changes)
```

## Configuration Entities

### 1. Aspire SQL Server Resource

**Purpose**: Represents the Aspire-managed SQL Server instance

**Attributes**:
- **Resource Name**: `"sql"` - Identifier for the SQL Server resource in AppHost
- **Health Check**: Enabled - Reports SQL Server availability to Aspire dashboard
- **Connection Type**: Containerized (development) or External (production)
- **Databases**: Collection of named databases (`registrationdb`, `eventingdb`)

**Lifecycle**:
- **Development**: Aspire provisions containerized SQL Server automatically
- **Production**: Connects to existing SQL Server instance using secure parameters
- **Startup**: SQL Server must be healthy before dependent services start

---

### 2. Registration Database Resource

**Purpose**: Named database resource for Registration service data

**Attributes**:
- **Resource Name**: `"registrationdb"`
- **Parent**: SQL Server resource `"sql"`
- **Connection String**: Auto-generated by Aspire, injected into Registration service
- **Schema**: Managed by `RegistrantDB` DbContext (existing)
- **Migrations**: EF Core migrations from `Visage.Services.Registrations/Migrations/`

**Referenced By**:
- `Visage.Services.Registrations` service

---

### 3. Eventing Database Resource

**Purpose**: Named database resource for Eventing service data

**Attributes**:
- **Resource Name**: `"eventingdb"`
- **Parent**: SQL Server resource `"sql"`
- **Connection String**: Auto-generated by Aspire, injected into Eventing service
- **Schema**: Managed by `EventDB` DbContext (existing)
- **Migrations**: EF Core migrations from `Visage.Services.Eventing/Migrations/`

**Referenced By**:
- `Visage.Services.Eventing` service

---

### 4. Connection Configuration

**Purpose**: Aspire-managed connection string parameters

**Attributes (Development)**:
- **Server**: `localhost` or containerized SQL Server endpoint
- **Database**: Resource-specific (`registrationdb` or `eventingdb`)
- **Authentication**: Integrated or SQL authentication
- **Pooling**: Enabled (default)
- **Trust Server Certificate**: True (containerized development)

**Attributes (Production)**:
- **Server**: From Aspire parameters or environment configuration
- **Database**: Resource-specific (`registrationdb` or `eventingdb`)
- **Authentication**: Azure AD or SQL authentication with secure credentials
- **Pooling**: Enabled with production limits
- **Encryption**: Required
- **Trust Server Certificate**: False (production certificates)

---

## Existing Entity Relationships

### Registration Service Entities

**Note**: These entities are **unchanged** by this migration. Documented here for completeness.

- **Registrant**: User registration information (name, email, profile data)
- **RegistrationStatus**: Status tracking for attendee registrations
- **Profile**: Extended user profile data linked to Auth0 identity

**Relationships**: As defined in existing `RegistrantDB` DbContext

---

### Eventing Service Entities

**Note**: These entities are **unchanged** by this migration. Documented here for completeness.

- **Event**: Meetup event information (title, date, venue, capacity)
- **Session**: Individual sessions within an event
- **Venue**: Location information for events
- **Schedule**: Time slots and session scheduling

**Relationships**: As defined in existing `EventDB` DbContext

---

## Migration Strategy

### Database Creation

1. **Development**: Aspire automatically creates containerized SQL Server with both databases
2. **Production**: Databases must exist on external SQL Server before deployment

### Schema Migration

1. **Automatic Migration**: Services run `DbContext.Database.MigrateAsync()` on startup
2. **Migration Order**: No specific order required - each service manages its own database
3. **Rollback**: Use EF Core migration rollback commands if needed

### Data Migration

**Not applicable** - This is an infrastructure change only. No data model changes, so existing data can be:

- **Development**: Fresh start with empty containerized database
- **Production**: Backup/restore existing databases to new Aspire-managed instance if changing infrastructure

---

## Validation Rules

### Connection Validation

- Connection string MUST be injected by Aspire (not from appsettings.json)
- Services MUST wait for database health check before accepting requests
- Connection pooling MUST be enabled for performance

### Health Check Validation

- SQL Server resource MUST report healthy status to Aspire dashboard
- Database-specific health checks MUST verify connectivity
- Failed health checks MUST prevent service startup

### Migration Validation

- Migrations MUST complete successfully on first startup
- Migration failures MUST log detailed errors and prevent service startup
- Pending migrations MUST be detected and applied automatically

---

## State Transitions

### Service Startup States

```
1. Service Starting
   ↓
2. Waiting for SQL Server (via .WaitFor())
   ↓
3. SQL Server Healthy
   ↓
4. Acquiring Connection String from Aspire
   ↓
5. Connecting to Database
   ↓
6. Running Migrations
   ↓
7. Service Ready
```

### Health Check States

```
SQL Server Health:
- Starting → Unhealthy
- Running → Healthy
- Error → Unhealthy
- Stopped → Unhealthy

Service Health (depends on SQL Server):
- SQL Server Unhealthy → Service Unhealthy
- SQL Server Healthy + Migrations Complete → Service Healthy
- SQL Server Healthy + Migrations Failed → Service Unhealthy
```

---

## Security Considerations

### Connection String Security

- **Development**: User secrets or default containerized credentials
- **Production**: Azure Key Vault or Aspire secure parameters
- **Never**: Plain-text connection strings in source control

### Database Permissions

- **Services**: Minimum required permissions (read/write to own database only)
- **Migrations**: DDL permissions for schema changes
- **Health Checks**: Read-only connectivity check

---

## Performance Considerations

### Connection Pooling

- **Min Pool Size**: 0 (default)
- **Max Pool Size**: 100 (default, adjust for load)
- **Connection Lifetime**: 0 (unlimited, reused)
- **Connection Timeout**: 30 seconds (default)

### Migration Performance

- **Execution**: Synchronous on first startup
- **Impact**: One-time cost per deployment
- **Optimization**: Keep migrations small and focused

---

## Summary

This data model document confirms that:

1. **No new entities** are introduced - this is an infrastructure migration
2. **Existing entities** in both services remain unchanged
3. **Database resources** are now managed by Aspire with automatic connection injection
4. **Connection security** is improved through Aspire parameter management
5. **Health monitoring** is integrated with Aspire dashboard

Next steps: Create quickstart.md and update agent context.
